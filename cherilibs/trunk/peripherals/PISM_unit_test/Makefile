#!/usr/bin/make -f
#
# This file was automatically generated by makemakefile on Thu Nov 10 17:47:00 2011
#

BSC=bsc
BSCFLAGS=-keep-fires -cross-info
SUFFIXES=
CFLAGS=
# -lSDL

TOPMOD = mkPISM_unit_test
TOPFILE = PISM_unit_test.bsv
TOPPACK = $(basename $(TOPFILE))
SIMULATOR = bluesim

FILENAME = .lastmakesim

SRCS = *.bsv

CHERILIBS_DIR = ../..
INCLUDE_DIR = $(CHERILIBS_DIR)/include
TOOLS_DIR   = $(CHERILIBS_DIR)/tools

C_HEADERS=$(INCLUDE_DIR)/parameters.h
LD_LIBRARY_PATH=../../

PISM_C_FILES=	\
	../pism.c		\
	../DRAM/dram.c		\
	../UART/uart.c \
	../EtherCAP/ethercap.c

EXTRA_LINK=				\
	$(PISM_C_FILES)

LASTSIM := $(shell cat $(FILENAME) 2>/dev/null)

all:	run

ifdef SIM
SIMULATOR := $(SIM)
endif

# This means that there is a new sim type, force an update
ifneq ($(LASTSIM), $(SIM))
.PHONY:	$(TOPPACK).bo
endif

# An override on the Make commandline, remember this
ifdef SIM
FILECMD = @echo $(SIM) > $(FILENAME)
else
FILECMD = $(shell rm $(FILENAME)  2>/dev/null)
endif

# Bluesim and Verilog simulators use two very different bsc calls
ifeq ($(SIMULATOR),bluesim)
CMD1 =	$(BSC) $(BSCFLAGS) -sim -g $(TOPMOD) -u $(TOPFILE)
CMD2 =	$(BSC) $(BSCFLAGS) -sim -o $@  -e $(CFLAGS) $(TOPMOD)  $(TOPMOD).ba $(EXTRA_LINK)
else
CMD1 =	$(BSC) $(BSCFLAGS) -u -verilog -g $(TOPMOD) $(TOPFILE)
CMD2 =	$(BSC) $(BSCFLAGS) -verilog -vsim $(SIMULATOR) -e $(TOPMOD) -o $@ $(TOPMOD).v
endif


#
# Developer section and development targets for testing
#
pism:	$(PISM_C_FILES) ../pism.h
	$(CC) $(CFLAGS) -DPISM_TEST_PROG -std=c99 -Wall -pedantic -I include -o pism $(PISM_C_FILES)

pism_modules:
	$(MAKE) -C ../../peripherals

.PHONY: help
help:
	@echo "Possible targets:"
	@echo "  build         --  compile $(TOPFILE) for the default simulator ($(SIMULATOR))"
	@echo "  link          --  Link compiled files for default simulator ($(SIMULATOR))"
	@echo "  run           --  build, link, and simulate using default ($(SIMULATOR)) simulator"
	@echo "  clean         --  remove binary, executable and temporary files"
	@echo "  help          --  display this message"
	@echo " override the default simulator: make build SIM=iverilog"

# ----------------------------------------------------------------
# Executing with Bluesim simulation

.PHONY: build
build:	$(TOPPACK).bo pism_modules

# compile and link the whole system
$(TOPPACK).bo: $(SRCS) Makefile 
	$(FILECMD)
	$(CMD1)

.PHONY: link
link:	$(TOPMOD)

$(TOPMOD): $(TOPPACK).bo
	$(CMD2)

# run (simulate) the system
run:	$(TOPMOD) pism_modules
	./$(TOPMOD)

.PHONY: clean
clean:
	rm -f  *.bi *.bo *.ba *.info *.sched *.c *.h *.o *.so  mk*.v  *~ $(TOPMOD) v95/* >/dev/null
